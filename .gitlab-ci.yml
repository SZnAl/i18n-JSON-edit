stages:
  - nodejs_build
  - docker_image_build
  - deploy_to_kubernetes
  - remove_for_kubernetes

# -------- nodejs start -------- #
nodejs_build:
  stage: nodejs_build
  cache:
    key: "${CI_PROJECT_NAME}"
    paths:
      - node_modules/
  script:
    - npm config -g set registry https://registry.npmmirror.com
    - yarn config set registry https://registry.npmmirror.com
    - npm install
    - npm run build
  artifacts:
    name: ${CI_PROJECT_NAME}
    paths:
      - dist/
  tags:
    - nodejs-14
# -------- nodejs end -------- #

# -------- kaniko start -------- #
docker_image_build:
  stage: docker_image_build
  needs:
    - job: nodejs_build
  variables:
    registry: ${CI_REGISTRY}
    registry_auth: ${CI_REGISTRY_AUTH}
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${registry}\":{\"auth\":\"${registry_auth}\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --cache=true
      --cache-copy-layers
      --push-retry=3
      --context ${CI_PROJECT_DIR}
      --dockerfile ${CI_PROJECT_DIR}/Dockerfile
      --destination ${CI_REGISTRY_IMAGE}/${CI_PROJECT_NAME}:${CI_COMMIT_SHORT_SHA}-${CI_PIPELINE_IID}
  tags:
    - kaniko
# -------- kaniko end -------- #

# -------- helm start -------- #
helm_deploy:
  stage: deploy_to_kubernetes
  needs:
    - job: docker_image_build
  environment:
    name: ${CI_PROJECT_NAME}
    url: "https://translate.superhii.com"
    on_stop: helm_remove
  variables:
    KUBECONFIG: "/root/.kube/local"
    registry: ${CI_REGISTRY_IMAGE}
    helm_repo: "local"
    namespace: "chaohi-public"
  dependencies: []
  script:
    - helm repo update
    - helm upgrade
      --install ${CI_PROJECT_NAME} ${helm_repo}/${CI_PROJECT_NAME}
      --namespace=${namespace}
      --set image.repository=${registry}/${CI_PROJECT_NAME}
      --set image.tag=${CI_COMMIT_SHORT_SHA}-${CI_PIPELINE_IID}
      --set imagePullSecrets="local-registry"
      --set logs.test="true"
      --set ingress.enabled="true"
      --set-string ingress.annotations."nginx\.ingress\.kubernetes\.io/proxy-body-size"=200m
      --set-string ingress.annotations."nginx\.ingress\.kubernetes\.io/ssl-redirect"="false"
      --set-string ingress.annotations."external-dns\.alpha\.kubernetes\.io/hostname"="translate.superhii.com"
      --set ingress.hosts[0].host="translate.superhii.com"
      --set ingress.tls[0].secretName="superhii-com"
      --set ingress.tls[0].hosts[0]="translate.superhii.com"
  retry: 2
  tags:
    - helm

helm_remove:
  stage: remove_for_kubernetes
  needs:
    - job: helm_deploy
  when: manual
  allow_failure: true
  environment:
    name: ${CI_PROJECT_NAME}
    action: stop
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: "/root/.kube/local"
    registry: ${CI_REGISTRY_IMAGE}
    helm_repo: "local"
    namespace: "chaohi-public"
  dependencies: []
  script:
    - helm uninstall 
      --namespace=${namespace}
      ${CI_PROJECT_NAME}
  retry: 2
  tags:
    - helm
# -------- helm end -------- #
